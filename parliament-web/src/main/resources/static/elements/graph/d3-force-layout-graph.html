<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module name="d3-force-layout-graph">
	<template>
		<svg id="graph" width="960" height="500"></svg>
	</template>
	<script>
		Polymer({
			is: 'd3-force-layout-graph',
			
			properties: {
				graph: {
					type: Object,
					value: eval({"nodes":[{"id":"ohne Klubzugehörigkeit","label":"ohne Klubzugehörigkeit"},{"id":"GRÜNE","label":"GRÜNE"},{"id":"SPÖ","label":"SPÖ"},{"id":"NEOS-LIF","label":"NEOS-LIF"},{"id":"FPÖ","label":"FPÖ"},{"id":"ÖVP","label":"ÖVP"},{"id":"STRONACH","label":"STRONACH"},{"id":"NEOS","label":"NEOS"}],"links":[{"source":2,"target":7,"weight":0.07680491551459294},{"source":5,"target":2,"weight":0.8294930875576036},{"source":0,"target":3,"weight":0.01152073732718894},{"source":7,"target":5,"weight":0.023809523809523808},{"source":6,"target":1,"weight":0.05145929339477726},{"source":3,"target":7,"weight":0.04992319508448541},{"source":1,"target":0,"weight":0.026881720430107527},{"source":2,"target":4,"weight":-0.6682027649769585},{"source":5,"target":1,"weight":-0.1835637480798771},{"source":1,"target":3,"weight":0.1597542242703533},{"source":6,"target":2,"weight":-0.039938556067588324},{"source":3,"target":4,"weight":0.060675883256528416},{"source":4,"target":5,"weight":-0.21812596006144394},{"source":1,"target":7,"weight":0.17357910906298002},{"source":0,"target":4,"weight":0.03609831029185868},{"source":3,"target":0,"weight":0.0069124423963133645},{"source":2,"target":0,"weight":-0.06835637480798772},{"source":2,"target":3,"weight":0.06835637480798772},{"source":1,"target":4,"weight":0.2542242703533026},{"source":0,"target":7,"weight":0.01228878648233487},{"source":7,"target":0,"weight":0.0069124423963133645},{"source":1,"target":5,"weight":-0.08064516129032258},{"source":4,"target":7,"weight":0.09831029185867896},{"source":5,"target":6,"weight":-0.15514592933947774},{"source":7,"target":3,"weight":0.0445468509984639},{"source":0,"target":5,"weight":-0.013824884792626729},{"source":3,"target":5,"weight":0.023809523809523808},{"source":4,"target":0,"weight":0.03763440860215054},{"source":2,"target":5,"weight":1.0},{"source":7,"target":4,"weight":0.06144393241167435},{"source":4,"target":3,"weight":0.08294930875576037},{"source":5,"target":3,"weight":0.016129032258064516},{"source":0,"target":2,"weight":-0.016897081413210446},{"source":7,"target":6,"weight":0.07296466973886329},{"source":6,"target":0,"weight":0.009216589861751152},{"source":6,"target":3,"weight":0.03302611367127496},{"source":1,"target":2,"weight":-0.09523809523809523},{"source":0,"target":1,"weight":0.021505376344086023},{"source":5,"target":0,"weight":-0.0706605222734255},{"source":6,"target":7,"weight":0.03840245775729647},{"source":2,"target":1,"weight":-0.20967741935483872},{"source":5,"target":4,"weight":-0.5368663594470046},{"source":4,"target":6,"weight":0.2350230414746544},{"source":3,"target":1,"weight":0.026881720430107527},{"source":6,"target":4,"weight":0.09523809523809523},{"source":5,"target":7,"weight":0.029185867895545316},{"source":3,"target":2,"weight":-0.018433179723502304},{"source":1,"target":6,"weight":0.16666666666666666},{"source":6,"target":5,"weight":-0.05913978494623656},{"source":7,"target":1,"weight":0.026881720430107527},{"source":0,"target":6,"weight":0.018433179723502304},{"source":7,"target":2,"weight":-0.018433179723502304},{"source":2,"target":6,"weight":-0.21121351766513058},{"source":3,"target":6,"weight":0.07296466973886329},{"source":4,"target":1,"weight":0.18049155145929338},{"source":4,"target":2,"weight":-0.20353302611367127}]})
				}
			},
			
			attached: function(){
				this.createGraph();
			}, 
			
			createGraph: function() {
				var graphElement = d3.select('#graph');

				var width = this.$.graph.offsetWidth;
				var height = this.$.graph.offsetHeight;
				
				console.log(width);
				console.log(height);
				
				var labelAnchors = [];
				var labelAnchorLinks = [];
				var nodes = this.graph.nodes;
				var links = this.graph.links;

				for(var i = 0; i < nodes.length; i++) {
					labelAnchors.push({
						node : nodes[i]
					});
					labelAnchors.push({
						node : nodes[i]
					});
					console.log(nodes[i].label);
				};
				
				for(var i = 0; i < nodes.length; i++) {
					labelAnchorLinks.push({
						source : i * 2,
						target : i * 2 + 1,
						weight : 1
					});
				};
				
				var force = d3.layout.force().size([width, height]).nodes(nodes).links(links).gravity(1).linkDistance(50).charge(-3000).linkStrength(function(x) {
					return x.weight / 1.5;
				});
				
				force.start();

				var force2 = d3.layout.force().nodes(labelAnchors).links(labelAnchorLinks).gravity(0).linkDistance(0).linkStrength(8).charge(-100).size([width, height]);
				force2.start();
				
				var link = graphElement.selectAll("line.link").data(links).enter().append("svg:line").attr("class", "link").style("stroke", "#CCC");

				var node = graphElement.selectAll("g.node").data(force.nodes()).enter().append("svg:g").attr("class", "node");
				node.append("svg:circle").attr("r", 5).style("fill", "#555").style("stroke", "#FFF").style("stroke-width", 3);
				node.call(force.drag);
				
				var anchorLink = graphElement.selectAll("line.anchorLink").data(labelAnchorLinks)//.enter().append("svg:line").attr("class", "anchorLink").style("stroke", "#999");

				var anchorNode = graphElement.selectAll("g.anchorNode").data(force2.nodes()).enter().append("svg:g").attr("class", "anchorNode");
				anchorNode.append("svg:circle").attr("r", 0).style("fill", "#FFF");
					anchorNode.append("svg:text").text(function(d, i) {
					return i % 2 == 0 ? "" : d.node.label
				}).style("fill", "#555").style("font-family", "Arial").style("font-size", 12);
					
				var updateLink = function() {
					this.attr("x1", function(d) {
						return d.source.x;
					}).attr("y1", function(d) {
						return d.source.y;
					}).attr("x2", function(d) {
						return d.target.x;
					}).attr("y2", function(d) {
						return d.target.y;
					});
				}

				var updateNode = function() {
					this.attr("transform", function(d) {
						return "translate(" + d.x + "," + d.y + ")";
					});
				}
					
				force.on("tick", function() {

					force2.start();

					node.call(updateNode);

					anchorNode.each(function(d, i) {
						if(i % 2 == 0) {
							d.x = d.node.x;
							d.y = d.node.y;
						} else {
							var b = this.childNodes[1].getBBox();

							var diffX = d.x - d.node.x;
							var diffY = d.y - d.node.y;

							var dist = Math.sqrt(diffX * diffX + diffY * diffY);

							var shiftX = b.width * (diffX - dist) / (dist * 2);
							shiftX = Math.max(-b.width, Math.min(0, shiftX));
							var shiftY = 5;
							this.childNodes[1].setAttribute("transform", "translate(" + shiftX + "," + shiftY + ")");
						}
					});


					anchorNode.call(updateNode);

					link.call(updateLink);
					anchorLink.call(updateLink);

				});

			}
		});
	</script>
</dom-module>